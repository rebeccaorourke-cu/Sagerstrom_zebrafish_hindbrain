---
title: "Neural subsets 3WT integrated analysis R Notebook"
author: "Rebecca O'Rourke"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, results=F}
suppressPackageStartupMessages({
  library(Seurat)
  library(org.Dr.eg.db)
  library(BSgenome.Drerio.UCSC.danRer11)
  library(Signac)
  library(knitr)
  library(kableExtra)
  library(dplyr)
  library(ggplot2)
  library(ggsci)
  library(limma)
  library(JASPAR2020)
  library(patchwork)
  library(TFBSTools)
  library(motifmatchr)
  library(AnnotationHub)
  library(harmony)
})
options(future.globals.maxSize = 4000 * 1024^2)
```

# Read data
```{r}
int.3WT <- readRDS(file = "RDSfiles/int.neural.3WT.RDS")
```

```{r, fig.width=10, fig.height=5, results=F}
p1 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "wsnn_res.0.8", label = T, repel = T) + scale_color_igv() + NoLegend()
p2 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "Clusters", label = T, repel = T) + scale_color_igv() + NoLegend()
p1 + p2
```

# Increase cluster resolution
```{r}
# remove old individual cluster resolutions
int.3WT$wsnn_res.1 <- NULL
int.3WT$wsnn_res.1.5 <- NULL
int.3WT$wsnn_res.2 <- NULL
int.3WT$wsnn_res.2.5 <- NULL
int.3WT$wsnn_res.3 <- NULL
int.3WT$wsnn_res.3.5 <- NULL
int.3WT$wsnn_res.6 <- NULL
int.3WT$wsnn_res.8 <- NULL
```

```{r}
int.3WT <- FindClusters(int.3WT, graph.name = "wsnn", resolution = 2, algorithm = 3, verbose = FALSE)
int.3WT <- FindClusters(int.3WT, graph.name = "wsnn", resolution = 3, algorithm = 3, verbose = FALSE)
int.3WT <- FindClusters(int.3WT, graph.name = "wsnn", resolution = 4, algorithm = 3, verbose = FALSE)
int.3WT <- FindClusters(int.3WT, graph.name = "wsnn", resolution = 5, algorithm = 3, verbose = FALSE)
int.3WT <- FindClusters(int.3WT, graph.name = "wsnn", resolution = 6, algorithm = 3, verbose = FALSE)
```

```{r, fig.width=10, fig.height=10}
p1 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "wsnn_res.2", label = T, repel = T) + scale_color_igv() + NoLegend()
p2 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "wsnn_res.3", label = T, repel = T) + scale_color_igv() + NoLegend()
p3 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "wsnn_res.4", label = T, repel = T) + scale_color_igv() + NoLegend()
p4 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "wsnn_res.5", label = T, repel = T) + scale_color_igv() + NoLegend()
p5 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "wsnn_res.6", label = T, repel = T) + scale_color_igv() + NoLegend()
p6 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "Clusters", label = T, repel = T) + scale_color_igv() + NoLegend()
(p1 + p2 + p3) / (p4 + p5 + p6)

```

```{r}
saveRDS(int.3WT, file = "RDSfiles/int.neural.3WT.RDS")
```


### Resolution Note

Based on what I'm seeing resolution 5 might be what we want since it separates r1, r2, r1&r2, r4 and DorsNT into separate clusters.  Resolution 6 only further resolves cluster 5 in res 5 (MHB) into clusters 18 and 28 in res 6.

## Res 5 clustering split by Sample
```{r, fig.width=10, fig.height=5}
p1 <- DimPlot(int.3WT, reduction = "wnn.umap", group.by = "wsnn_res.5", split.by = "orig.ident", label = T, repel = T) + scale_color_igv()
p1
```

## Original Cluster names split by Sample
```{r, fig.width=10, fig.height=5}
DimPlot(int.3WT, reduction = "wnn.umap", group.by = "Clusters", split.by = "orig.ident", label = T, repel = T, ncol = 3) + scale_color_igv() + NoLegend()
```

## Tables of Cell Counts
```{r}
as.data.frame(table(int.3WT$Clusters, int.3WT$wsnn_res.5)) %>%
  tidyr::pivot_wider(names_from = "Var2", values_from = "Freq") %>%
  rename("Cluster" = "Var1") %>%
  mutate(Cluster = gsub(" ","",Cluster)) %>%
  mutate(across(everything(), gsub, pattern = "^0$", replacement = ".")) %>%
  kbl(caption = "Cell Count Orig Clusters by Res 5 clusters") %>%
  kable_classic(full_width = F, "striped")
```

```{r}
as.data.frame(table(int.3WT$orig.ident, int.3WT$wsnn_res.5)) %>%
  tidyr::pivot_wider(names_from = "Var2", values_from = "Freq") %>%
  rename("Sample" = "Var1") %>%
  kbl(caption = "Cell Count Sample by Res 5 clusters") %>%
  kable_classic(full_width = F, "striped")
```

```{r}
as.data.frame(table(int.3WT$Clusters, int.3WT$orig.ident)) %>%
  tidyr::pivot_wider(names_from = "Var2", values_from = "Freq") %>%
  rename("Cluster" = "Var1") %>%
  mutate(Cluster = gsub(" ","",Cluster)) %>%
  mutate(across(everything(), gsub, pattern = "^0$", replacement = ".")) %>%
  kbl(caption = "Cell Count Orig Clusters by Sample") %>%
  kable_classic(full_width = F, "striped")
```

```{r}
as.data.frame(table(int.3WT$Clusters[int.3WT$orig.ident == "HB10hpf"], int.3WT$wsnn_res.5[int.3WT$orig.ident == "HB10hpf"])) %>%
  tidyr::pivot_wider(names_from = "Var2", values_from = "Freq") %>%
  rename("Cluster" = "Var1") %>%
  mutate(Cluster = gsub(" ","",Cluster)) %>%
  mutate(across(everything(), gsub, pattern = "^0$", replacement = ".")) %>%
  kbl(caption = "HB10hpf cell count") %>%
  kable_classic(full_width = F, "striped")
```

```{r}
as.data.frame(table(int.3WT$Clusters[int.3WT$orig.ident == "HB13hpf"], int.3WT$wsnn_res.5[int.3WT$orig.ident == "HB13hpf"])) %>%
  tidyr::pivot_wider(names_from = "Var2", values_from = "Freq") %>%
  rename("Cluster" = "Var1") %>%
  mutate(Cluster = gsub(" ","",Cluster)) %>%
  mutate(across(everything(), gsub, pattern = "^0$", replacement = ".")) %>%
  kbl(caption = "HB13hpf cell count") %>%
  kable_classic(full_width = F, "striped")
```

```{r}
as.data.frame(table(int.3WT$Clusters[int.3WT$orig.ident == "HB16hpf"], int.3WT$wsnn_res.5[int.3WT$orig.ident == "HB16hpf"])) %>%
  tidyr::pivot_wider(names_from = "Var2", values_from = "Freq") %>%
  rename("Cluster" = "Var1") %>%
  mutate(Cluster = gsub(" ","",Cluster)) %>%
  mutate(across(everything(), gsub, pattern = "^0$", replacement = ".")) %>%
  kbl(caption = "HB16hpf cell count") %>%
  kable_classic(full_width = F, "striped")
```

## Remove FB and FB&eye clusters

Rational: the amount of FB or FB&eye was dissection specific and not possible to precisely control.

After examining Cell Count Original Clusters by Res 5 clusters will remove clusters:
11, 18, 22, 23, 32 and 38

Will keep 29 -- this has lots of cells from a variety of clusters and may be interesting
Will keep 5 -- this is in with MB clusters and may have been mislabeled previously.  
Will also keep 30 since this more closely associated with MB clusters than FB clusters.

```{r, fig.width=5, fig.height=5}
Idents(int.3WT) <- "wsnn_res.5"
int.3WT.subset <- subset(int.3WT, idents = c("11","18","22","23","32","38"), invert = TRUE)
DimPlot(int.3WT.subset, reduction = "wnn.umap", label = T, repel = T) + scale_color_igv()
```

## Res 5 clustering split by Sample
```{r, fig.width=10, fig.height=5}
p1 <- DimPlot(int.3WT.subset, reduction = "wnn.umap", group.by = "wsnn_res.5", split.by = "orig.ident", label = T, repel = T) + scale_color_igv()
p1
```

## Original Cluster names split by Sample
```{r, fig.width=10, fig.height=5}
DimPlot(int.3WT.subset, reduction = "wnn.umap", group.by = "Clusters", split.by = "orig.ident", label = T, repel = T, ncol = 3) + scale_color_igv() + NoLegend()
```

```{r, fig.height=10, fig.width=10}
Idents(int.3WT.subset) <- "Clusters"
HB1cells <- WhichCells(int.3WT.subset, idents = "HB.1")
HB2cells <- WhichCells(int.3WT.subset, idents = "HB.2")
HB3cells <- WhichCells(int.3WT.subset, idents = "HB.3")
p1 <- DimPlot(int.3WT.subset, group.by = "wsnn_res.5", cells.highlight = HB1cells, reduction = "wnn.umap") + NoLegend() + ggtitle("HB.1 cells")
p2 <- DimPlot(int.3WT.subset, group.by = "wsnn_res.5", cells.highlight = HB2cells, reduction = "wnn.umap") + NoLegend() + ggtitle("HB.2 cells")
p3 <- DimPlot(int.3WT.subset, group.by = "wsnn_res.5", cells.highlight = HB3cells, reduction = "wnn.umap") + NoLegend() + ggtitle("HB.3 cells")
p4 <- DimPlot(int.3WT.subset, group.by = "wsnn_res.5", reduction = "wnn.umap", label = TRUE, repel = T) + NoLegend() + scale_color_igv()
(p1 + p2) / (p3 + p4)
```
Since there are still a few cells which were originally called FB or FB&eye in other clusters, these labels are still in the metadata table and are still cluttering up the UMAP.  So will remove all labels with "FB" in them from UMAP of cluster labels.

```{r}
int.3WT.subset$fixedClusters <- int.3WT.subset$Clusters
int.3WT.subset$fixedClusters[grep("FB", int.3WT.subset$fixedClusters)] <- " "
```

```{r, fig.height=10, fig.width=10}
p1 <- DimPlot(int.3WT.subset, group.by = "fixedClusters", cells.highlight = HB1cells, reduction = "wnn.umap") + NoLegend() + ggtitle("HB.1 cells")
p2 <- DimPlot(int.3WT.subset, group.by = "fixedClusters", cells.highlight = HB2cells, reduction = "wnn.umap") + NoLegend() + ggtitle("HB.2 cells")
p3 <- DimPlot(int.3WT.subset, group.by = "fixedClusters", cells.highlight = HB3cells, reduction = "wnn.umap") + NoLegend() + ggtitle("HB.3 cells")
p4 <- DimPlot(int.3WT.subset, group.by = "fixedClusters", reduction = "wnn.umap", label = TRUE, repel = T) + NoLegend() + scale_color_igv()
(p1 + p2) / (p3 + p4)
```

```{r, results=F}
Idents(int.3WT.subset) <- "wsnn_res.5"
All.markers <- FindAllMarkers(int.3WT.subset, only.pos = TRUE)
write.table(All.markers, file = "../results/int3WT.subset.markers.res.5.txt", sep = "\t", quote = F, col.names = NA) ## Data_S4
```

```{r}
cellCount <- as.data.frame(table(int.3WT.subset$Clusters, int.3WT.subset$wsnn_res.5, int.3WT.subset$orig.ident)) %>%
  dplyr::filter(!Freq == 0)
write.table(cellCount, file = "../results/int3WT.cellCount.res.5.txt", quote = F, sep = "\t", row.names = FALSE)
```

After determining cluster cell types, adding as "intClusters"

```{r}
DimPlot(int.3WT.subset, group.by = "wsnn_res.5", reduction = "wnn.umap", label = TRUE, repel = T) + NoLegend() + scale_color_igv()
```

```{r}
Idents(int.3WT.subset) <- "wsnn_res.5"
int.3WT.subset <- RenameIdents(int.3WT.subset,
                               "0" = "CaudHB.1",
                               "1" = "SC.1",
                               "2" = "r3.1",
                               "3" = "CaudHB.2",
                               "4" = "MB.1",
                               "5" = "MHB.1",
                               "6" = "MHB.2",
                               "7" = "Neuron.1",
                               "8" = "CaudHB.3",
                               "9" = "MHB.3",
                               "10" = "SC.2",
                               "12" = "r1&r2.1",
                               "13" = "r4.1",
                               "14" = "MB.2",
                               "15" = "r1",
                               "16" = "r2",
                               "17" = "r5.1",
                               "19" = "SC.3",
                               "20" = "r4.2",
                               "21" = "r5.2",
                               "24" = "SC.4",
                               "25" = "MHB.4",
                               "26" = "MHB.5",
                               "27" = "r6.1",
                               "28" = "Ciliated",
                               "29" = "Neurog",
                               "30" = "MB.3",
                               "31" = "r6.2",
                               "33" = "r1&r2.2",
                               "34" = "CaudHB.4",
                               "35" = "Neuron.2",
                               "36" = "NC.1",
                               "37" = "HB",
                               "39" = "NC.2",
                               "40" = "MHB.6",
                               "41" = "Mitochondrial")
int.3WT.subset$intClusters <- Idents(int.3WT.subset)
```

```{r}
DimPlot(int.3WT.subset, reduction = "wnn.umap", label = TRUE, repel = T) + NoLegend() + scale_color_igv() + ggtitle("Integrated Neural Clusters")
```

```{r}
saveRDS(int.3WT.subset, file = "RDSfiles/int.neural.3WT.subset.RDS")
```

```{r}
sessionInfo()
```

